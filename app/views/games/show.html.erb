<div class="row">
	<div class="col s6 offset-s3">
		<h3><%= @game.name %></h3>
	</div>
</div>
<div class="row">
	<div class="col s6">
	p1
	</div>
	<div class="col s6">
	p2
	</div>
</div>	
<div class="row">
	<div class="col s6">
		<button id="get" class="btn waves-effect">Test Get</button>
	</div>
	<div class="col s6">
		<button id="post" class="btn waves-effect">Test Post</button>
	</div>
</div>

<script type="text/javascript">
	$(document).ready(function () {

		var game_state = setInterval(function() { get_game() }, 500);
		setTimeout(function() { clearInterval(game_state)}, 3000);

		/**
		 * Get the correct or incorrect letters
		 * @param  bool is to toggle between correct/incorrect array
		 * @return Array
		 */
		function getLetters(bool){
			if(bool){
				return JSON.parse(localStorage.getItem('CSE3901_incorrect_letters') || "[]");
			} else {
				return JSON.parse(localStorage.getItem('CSE3901_correct_letters') || "[]");
			}
		}

		/**
		 * Set the game state in storage
		 * @param JSON game object
		 */
		function setGameStorage (game) {
			localStorage.setItem('CSE3901_game', JSON.stringify(game));
		}

		/**
		 * Get the game object
		 * @return JSON game object
		 */
		function getGameStorage (){
			return JSON.parse(localStorage.getItem('CSE3901_game')) || {};
		}

		/**
		 * Add a letter to either correct or incorrect array
		 * @param letter String
		 * @param bool 	boolean to toggle between correct and incorrect
		 */
		function addLetter(bool, letter){
			var letters = getLetters(bool);
			if(bool){
				//put it in correct array
				letters.push(letter);
			} else {
				//put it in incorrect array
				letters.push(letter);
			}
		}

		/**
		 * Grab the current game word.
		 * @return String
		 */
		function getWord() {
			return localStorage.getItem('CSE3901_target_letters') || " ";
		}

		/**
		 * Checks if user has won or lost
		 * @return integer: 1 => win, 0 => loss, 2 => neither 
		 */
		function checkWinLoss () {
			var target_word = getWord();
			var correct_letters = getLetters(true);
			var incorrect_letters = getLetters(false);

			if(correct_letters.length == target_word.length){
				return 1;
			} else if(incorrect_letters.length >= 5) {
				return 0;
			} else {
				return 2;
			}
		}

		/**
		 * Check if the letter is in the word to be guessed
		 * and if they won/lost neither
		 * @return boolean
		 */
		function handleLetter(letter) {
			var word = getWord();
			console.log(word);
			var i = 0, word_length = word.length - 1;
			while(word.indexOf(i, letter) != -1) {
			   i = word.indexOf(i, letter) + 1;
			}

			if(i < word_length) {
			   	addLetter(false, letter);
			} else {
				addLetter(true, letter);
			}

			var game_status = checkWinLoss();

			send_data(game_status);
		}

		/**
		 * This method handles a letter click.
		 */
		$('.letter').click(function () {
			var letter = $(this).data('letter');
			handleLetter(letter);
		});

		/**
		 * This method gets the game state.
		 * @return data
		 */
		function get_game(){
			$.ajax({
				type:'GET',
				url: 'http://localhost:3000/run-game',
				data: {
					id: <%= @game.id %>
				},
				dataType: 'JSON',
				success: function (data){
					console.log(data);
					return data;
				},
				error: function (err) {
					console.log(err);
				}
			})
		}

		function send_data (game_status) {
			var game = getGameStorage();
			var correct_letters = getLetters(true);
			var incorrect_letters = getLetters(false);
			if (game.first_user_id == <%= @current_user.id %>) {
				//Current user is the first user
				game.first_user_progress = incorrect_letters.length;
				game.first_user_points = 500-(100*incorrect_letters.length);
				//check if they just won or lost
				if(game_status == 1 || game_status == 2){
					game.first_user_done = true;
				}
				//get back the game state
				setGameStorage(post(game));
			} else {
				//Current user is the second user
				game.second_user_progress = incorrect_letters.length;
				game.second_user_points = 500-(100*incorrect_letters.length);
				//check if they just won or lost
				if(game_status == 1 || game_status == 2){
					game.second_user_done = true;
				}
				//get back the game state
				setGameStorage(post(game));
			}
		}

		function post (data) {
			$.ajax({
				type:'POST',
				url: 'http://localhost:3000/run-game',
				data: data,
				dataType: 'JSON',
				success: function (data){
					console.log(data);
					return data;
				},
				error: function (err) {
					console.log(err);
				}
			});
		}
	});
</script>